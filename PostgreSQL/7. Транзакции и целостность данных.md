**Транзакции и целостность данных** — это ключевые концепции в реляционных базах данных, которые обеспечивают корректность, надежность и согласованность данных при выполнении операций.

### 1. **Что такое транзакция?**

**Транзакция** — это последовательность одной или нескольких операций над базой данных, которая выполняется как единое целое. Транзакции гарантируют, что все операции будут выполнены полностью или не выполнены вовсе, что предотвращает частичные изменения данных в случае ошибки.

Основные свойства транзакций описываются с помощью принципа **ACID**:

### 2. **ACID-свойства транзакций:**

#### 1. **Атомарность (Atomicity)**

Атомарность означает, что все операции внутри транзакции выполняются как единое целое: либо все операции успешно завершены, либо ни одна из них не завершена. Если на каком-то этапе транзакция прерывается (например, из-за ошибки), все изменения, внесённые до этого момента, откатываются, и база данных возвращается в исходное состояние.

**Пример:** При переводе денег между двумя счетами транзакция должна гарантировать, что либо деньги списываются с одного счета и зачисляются на другой, либо операция не происходит вовсе.

```SQL
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE account_id = 1;
UPDATE accounts SET balance = balance + 100 WHERE account_id = 2;
COMMIT;
```

Если возникнет ошибка в середине операции (например, при списании со счета), вся транзакция будет отменена (rollback), и база вернется в исходное состояние.

#### 2. **Согласованность (Consistency)**

Согласованность гарантирует, что транзакция переводит базу данных из одного допустимого состояния в другое. Все правила и ограничения базы данных, такие как уникальные ключи и ограничения внешних ключей, должны быть соблюдены до и после транзакции.

**Пример:** Если существует правило, что баланс на счете не может быть отрицательным, транзакция не должна его нарушить.

```SQL
UPDATE accounts SET balance = balance - 500 WHERE account_id = 1; -- ошибка, если баланс меньше 500
```

#### 3. **Изолированность (Isolation)**

Изолированность означает, что параллельные транзакции не влияют друг на друга. Это свойство гарантирует, что результат выполнения одной транзакции не будет виден другим транзакциям, пока она не будет завершена. Существуют разные уровни изоляции, которые определяют, насколько строго транзакции должны быть изолированы друг от друга.

Основные уровни изоляции:

- **READ UNCOMMITTED** — транзакции могут видеть незавершенные изменения других транзакций (самый низкий уровень изоляции).
- **READ COMMITTED** — транзакции видят только завершенные изменения других транзакций.
- **REPEATABLE READ** — транзакция видит данные на момент её начала, независимо от того, какие изменения произошли в других транзакциях.
- **SERIALIZABLE** — самый высокий уровень изоляции, который гарантирует, что транзакции выполняются последовательно, как если бы они выполнялись одна за другой.

#### 4. **Долговечность (Durability)**

Долговечность означает, что результаты завершенной транзакции сохраняются в базе данных и остаются доступными, даже если система потеряет питание или перезагрузится. Это достигается за счет сохранения данных на диск и использования механизмов восстановления после сбоев.

**Пример:** После завершения транзакции деньги, переведенные с одного счета на другой, останутся в системе, даже если произойдет отключение питания.

### 3. **Транзакции в SQL:**

- **BEGIN** — начало транзакции.
- **COMMIT** — фиксация транзакции (применение изменений).
- **ROLLBACK** — откат транзакции (отмена изменений).

**Пример работы с транзакцией:**

```SQL
BEGIN;
UPDATE accounts SET balance = balance - 200 WHERE account_id = 1;
UPDATE accounts SET balance = balance + 200 WHERE account_id = 2;
COMMIT;
```

В этом примере сначала начинается транзакция (`BEGIN`), затем выполняются два обновления: с одного счета списываются деньги, а на другой они добавляются. После успешного выполнения изменений транзакция фиксируется командой `COMMIT`.

Если возникнет ошибка на любом этапе, изменения могут быть отменены с помощью команды `ROLLBACK`.

### 4. **Зачем нужны транзакции?**

Транзакции обеспечивают следующие важные функции:

- **Целостность данных:** транзакции гарантируют, что данные будут оставаться в согласованном состоянии.
- **Безопасность:** если операция прерывается, данные не будут повреждены или оставлены в частично обновленном состоянии.
- **Удобство разработки:** транзакции упрощают работу с сложными операциями, состоящими из нескольких запросов.

---

### Заключение:

**Транзакции** — это мощный механизм для управления изменениями в базе данных. Они обеспечивают, что операции выполняются безопасно и эффективно, поддерживая согласованность и целостность данных в условиях многопользовательской работы и параллельных операций. Принципы **ACID** делают транзакции ключевым инструментом для работы с реляционными базами данных.