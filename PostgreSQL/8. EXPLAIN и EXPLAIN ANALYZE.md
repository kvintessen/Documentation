**EXPLAIN** и **EXPLAIN ANALYZE** — это инструменты для анализа производительности SQL-запросов, которые помогают понять, как именно база данных (например, PostgreSQL) выполняет запрос. Они предоставляют информацию о том, какие операции выполняются, как используются индексы, и сколько строк обрабатывается на каждом этапе выполнения запроса.

### 1. **EXPLAIN**

Команда `EXPLAIN` в PostgreSQL показывает план выполнения запроса, без его фактического выполнения. Это полезно для анализа того, как база данных **планирует** выполнить запрос.

**Пример использования:**

```SQL
EXPLAIN SELECT * FROM users WHERE email = 'example@example.com';
```

Вывод `EXPLAIN` может включать:

- **Типы операций** (например, Seq Scan, Index Scan, Nested Loop) — показывает, как база данных будет сканировать таблицу.
- **Стоимость (Cost)** — оценка количества ресурсов, необходимых для выполнения запроса. Это относительная метрика, которая показывает примерное время выполнения.
- **Строки (Rows)** — количество строк, которые база данных ожидает обработать на каждом этапе.
- **Ширина (Width)** — количество байтов, которые будут обработаны для каждой строки.

#### Пример вывода `EXPLAIN`:

```SQL
Seq Scan on users  (cost=0.00..25.00 rows=1 width=82)
  Filter: (email = 'example@example.com')
```

- **Seq Scan** — последовательное сканирование таблицы `users`. Это менее эффективный способ поиска, если таблица велика.
- **Cost=0.00..25.00** — "стоимость" выполнения запроса: от 0 (начало) до 25 (окончание). Меньшее значение означает более быструю операцию.
- **Rows=1** — PostgreSQL ожидает найти одну строку.
- **Width=82** — каждая строка занимает 82 байта.

### 2. **EXPLAIN ANALYZE**

`EXPLAIN ANALYZE` выполняет запрос и показывает **фактические данные о его выполнении**. В отличие от простого `EXPLAIN`, который предоставляет только план, `EXPLAIN ANALYZE` показывает, что произошло на самом деле: сколько времени было потрачено на каждый этап выполнения, сколько строк реально было обработано и прочие метрики.

**Пример использования:**
```SQL
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'example@example.com';
```

Вывод `EXPLAIN ANALYZE` включает те же элементы, что и обычный `EXPLAIN`, но добавляет реальные значения времени выполнения и фактическое количество обработанных строк.

#### Пример вывода `EXPLAIN ANALYZE`:

```SQL
Seq Scan on users  (cost=0.00..25.00 rows=1 width=82) (actual time=0.020..0.030 rows=1 loops=1)
  Filter: (email = 'example@example.com')
  Rows Removed by Filter: 999
Planning Time: 0.123 ms
Execution Time: 0.050 ms
```

- **actual time=0.020..0.030** — время выполнения этапа, от начала до конца.
- **rows=1** — реально найдено 1 строка (совпадает с ожиданиями плана).
- **Rows Removed by Filter: 999** — 999 строк были отфильтрованы.
- **Execution Time** — общее время выполнения запроса.

### Ключевые аспекты анализа:

1. **Типы операций:**
    
    - **Seq Scan (Последовательное сканирование)** — сканирование всей таблицы, что может быть неэффективным для больших таблиц.
    - **Index Scan** — использование индекса для ускорения поиска строк.
    - **Index Only Scan** — поиск только по индексу, не загружая данные таблицы.
    - **Nested Loop** — вложенный цикл, который выполняет несколько подзапросов.
    - **Hash Join / Merge Join** — разные методы объединения таблиц.
2. **Cost (стоимость):**
    
    - Стоимость измеряется в условных единицах и отражает, насколько ресурсозатратен тот или иной этап выполнения запроса. Чем меньше стоимость, тем быстрее будет выполнен запрос.
3. **Rows (строки):**
    
    - `Rows` — это количество строк, которое PostgreSQL **ожидает** обработать на каждом этапе.
    - `Actual Rows` — это реальное количество строк, обработанных на каждом этапе.
4. **Время выполнения:**
    
    - `actual time` показывает реальное время, затраченное на каждый шаг выполнения запроса.

### Когда использовать `EXPLAIN` и `EXPLAIN ANALYZE`:

- **EXPLAIN** полезен для анализа плана выполнения запроса перед его фактическим выполнением. Это помогает увидеть, как база данных собирается выполнить запрос и какие индексы она собирается использовать.
- **EXPLAIN ANALYZE** используется для детального анализа реального выполнения запроса. Это необходимо, когда ты хочешь понять фактические проблемы с производительностью (например, время выполнения, реальные объемы данных и эффективность использования индексов).

### Пример использования для оптимизации:

Допустим, у нас есть запрос, который работает медленно:

```SQL
SELECT * FROM orders WHERE customer_id = 123;
```

Мы можем выполнить `EXPLAIN` и увидеть, что выполняется **Seq Scan**:

```SQL
Seq Scan on orders  (cost=0.00..1000.00 rows=500 width=100)
  Filter: (customer_id = 123)
```

Это означает, что запрос последовательно сканирует все строки в таблице, что медленно для больших таблиц. Для оптимизации можно создать индекс по `customer_id`:

```SQL
CREATE INDEX idx_customer_id ON orders(customer_id);
```

После этого, выполнив `EXPLAIN` снова, мы увидим, что PostgreSQL использует **Index Scan**:

```SQL
Index Scan using idx_customer_id on orders  (cost=0.00..50.00 rows=10 width=100)
  Index Cond: (customer_id = 123)
```

Теперь запрос будет выполняться быстрее, так как PostgreSQL использует индекс для быстрого поиска строк.

---

### Заключение:

- **EXPLAIN** помогает понять, как PostgreSQL собирается выполнить запрос, что позволяет найти потенциальные проблемы с производительностью.
- **EXPLAIN ANALYZE** показывает фактическое выполнение запроса, включая время и количество обработанных строк, что полезно для реального анализа и оптимизации сложных запросов.